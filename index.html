<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="云端学堂">
    <title>云端学习架构系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-bg: #1e2532; --sidebar-hover: #2a3441; --sidebar-active: #6366f1;
            --bg-color: #f8fafc; --text-main: #1e293b; --text-light: #64748b;
            --border-color: #e2e8f0; --accent-green: #10b981; --accent-purple: #6366f1;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-color); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* --- 侧边栏 --- */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; transition: 0.3s; z-index: 50; }
        .logo-area { padding: 20px; font-size: 18px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .course-list { flex-grow: 1; overflow-y: auto; padding: 15px 10px; }
        .course-item { 
            padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; color: #cbd5e1; font-size: 14px;
        }
        .course-item:hover { background: var(--sidebar-hover); color: white; }
        .course-item.active { background: var(--sidebar-active); color: white; font-weight: 600; }
        .user-info-area { padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 13px; }

        /* --- 移动端 --- */
        .mobile-header { display: none; background: var(--sidebar-bg); color: white; padding: 15px; justify-content: space-between; align-items: center; }
        .menu-toggle { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* --- 主内容区 --- */
        main { flex-grow: 1; overflow-y: auto; padding: 40px; position: relative; }
        .course-title-pill { background: var(--sidebar-bg); color: white; padding: 10px 24px; border-radius: 30px; font-size: 16px; font-weight: bold; display: inline-block; margin-bottom: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .tree-container { display: flex; flex-direction: column; gap: 40px; position: relative; }
        .tree-container::before { content: ''; position: absolute; left: 16px; top: 0; bottom: 0; width: 1px; background: #cbd5e1; z-index: 0; }

        .week-row { display: flex; align-items: flex-start; position: relative; z-index: 1; }
        .week-box { 
            background: white; border: 1.5px solid var(--accent-purple); padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
            min-width: 200px; text-align: center; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .week-box::after { content: ''; position: absolute; right: -30px; top: 50%; width: 30px; height: 1px; background: #cbd5e1; }

        .modules-col { margin-left: 30px; display: flex; flex-direction: column; gap: 12px; position: relative; padding-top: 5px; }
        .modules-col::before { content: ''; position: absolute; left: -1px; top: 20px; bottom: 20px; width: 1px; background: #cbd5e1; }

        .module-card { 
            background: white; border-radius: 6px; padding: 12px 16px; font-size: 14px; border-left: 3px solid var(--accent-green); box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; min-width: 350px; position: relative; transition: 0.2s; cursor: pointer; color: var(--text-main);
        }
        .module-card:hover { transform: translateX(3px); box-shadow: 0 4px 6px rgba(0,0,0,0.08); }
        .module-card::before { content: ''; position: absolute; left: -15px; top: 50%; width: 12px; height: 1px; background: #cbd5e1; }
        .module-card.locked { border-left-color: #94a3b8; opacity: 0.7; }
        .module-card .mod-title { display: flex; align-items: center; gap: 8px; }

        /* --- 响应式 --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { position: fixed; left: -260px; height: 100vh; }
            #sidebar.open { left: 0; }
            .mobile-header { display: flex; }
            main { padding: 20px; }
            .week-row { flex-direction: column; gap: 20px; }
            .week-box { min-width: 100%; }
            .week-box::after { display: none; }
            .modules-col { margin-left: 10px; min-width: 100%; }
            .module-card { min-width: 100%; }
            .admin-panel { width: 100%; }
        }

        /* --- UI 组件 --- */
        .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--accent-purple); color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-ghost { background: transparent; color: inherit; border: 1px solid rgba(0,0,0,0.1); }
        .btn-success { background: var(--accent-green); color: white; }
        
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        body.is-admin .admin-only-block { display: block !important; }

        .sort-tool { display: flex; gap: 4px; align-items: center; }
        .sort-tool button { background: #f1f5f9; border: none; border-radius: 4px; padding: 4px; cursor: pointer; color: #64748b; }
        
        /* 管理面板 & 模态框 */
        .admin-panel { position: fixed; top: 0; right: 0; width: 400px; height: 100vh; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.1); padding: 30px; transform: translateX(100%); transition: 0.3s; z-index: 100; overflow-y: auto; }
        .admin-panel.open { transform: translateX(0); }
        .form-group { margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .form-group h3 { margin-bottom: 15px; font-size: 15px; color: var(--accent-purple); }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; }
        input, select { width: 100%; padding: 8px 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: inherit; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.6); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-box h2 { margin-bottom: 20px; font-size: 18px; text-align: center; }
        .user-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .user-list-table th, .user-list-table td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div style="font-weight: bold;">CloudEdu Hub</div>
        <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="sidebar">
        <div class="logo-area"><i class="fas fa-cloud"></i> CloudEdu Hub</div>
        <div class="course-list" id="courseList"></div>
        <div class="user-info-area">
            <div style="margin-bottom: 10px;">当前账号: <span id="currentUserLabel" style="color:var(--accent-green);font-weight:bold;">未登录</span></div>
            <button class="btn btn-ghost" style="width:100%; margin-bottom:8px; color:white; border-color:rgba(255,255,255,0.2);" onclick="showLogin()"><i class="fas fa-sign-in-alt"></i> 登录 / 切换账号</button>
            <button class="btn btn-primary admin-only-block" style="width:100%;" onclick="toggleAdminPanel()"><i class="fas fa-cog"></i> 管理后台</button>
        </div>
    </nav>

    <main><div id="mainCanvas"></div></main>

    <div class="admin-panel" id="adminPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>系统管理中心</h2>
            <button onclick="toggleAdminPanel()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div class="form-group">
            <h3><i class="fas fa-users"></i> 用户与权限管理</h3>
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="showUserManage()">管理所有账号 (分配权限)</button>
        </div>

        <div class="form-group">
            <h3><i class="fas fa-book"></i> 课程管理</h3>
            <input type="text" id="courseNameInput" placeholder="输入课程名称">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="addCourse()">保存课程</button>
                <button class="btn btn-danger" onclick="deleteCurrentCourse()">删除</button>
            </div>
        </div>

        <div class="form-group">
            <h3><i class="fas fa-file-alt"></i> 课件节点编辑</h3>
            <label>所属课程</label> <select id="parentCourseSelect"></select>
            <label>周次标题</label> <input type="text" id="weekInput" placeholder="例如: 第一周：商业金融导论...">
            <label>课件名称</label> <input type="text" id="moduleNameInput" placeholder="例如: 模块一：财务经理的角色...">
            <label>文件链接/路径</label> <input type="text" id="fileNameInput" placeholder="例如: courses/business_finance/Week1_Module1.html">
            <label>观看权限</label> 
            <select id="accessSelect">
                <option value="free">基础可见 (Free)</option>
                <option value="pro">仅高级权限可见 (Pro)</option>
            </select>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="saveModule()">发布 / 更新课件</button>
        </div>

        <div class="form-group" style="text-align:center;">
            <h3><i class="fas fa-database"></i> 数据安全与备份</h3>
            <p style="font-size:11px; color:#64748b; margin-bottom:10px; text-align:left;">此版本数据存在浏览器中，如需跨设备同步，请使用导出/导入功能。</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-success" onclick="exportData()"><i class="fas fa-download"></i> 导出备份</button>
                <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> 导入备份</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h2>系统登录</h2>
            <input type="text" id="loginId" placeholder="账号 (默认校长: admin1)">
            <input type="password" id="loginPwd" placeholder="密码 (默认: 123)">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="doLogin()">登录</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="closeModal('loginModal')">取消</button>
        </div>
    </div>

    <div class="modal-overlay" id="userManageModal">
        <div class="modal-box" style="width:450px;">
            <h2>账号管理与权限分配</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="newUserId" placeholder="新账号名" style="margin:0;">
                <input type="text" id="newUserPwd" placeholder="密码" style="margin:0;">
                <select id="newUserRole" style="margin:0; width:auto;">
                    <option value="student">学生</option>
                    <option value="admin">管理员</option>
                </select>
                <button class="btn btn-primary" onclick="addUser()">添加</button>
            </div>
            <div style="max-height:200px; overflow-y:auto;">
                <table class="user-list-table" id="userTable"></table>
            </div>
            <button class="btn btn-ghost" style="width:100%; margin-top:15px;" onclick="closeModal('userManageModal')">关闭</button>
        </div>
    </div>

    <script>
        // 在这里！我已经帮你把 DEFAULT_STATE 里的路径完美替换好了！
        const DEFAULT_STATE = {
            users: [
                { id: 'admin1', pwd: '123', role: 'admin', pro: true },
                { id: 'child', pwd: 'abc', role: 'student', pro: false }
            ],
            courses: [{id: 'business_finance', name: 'Business Finance'}],
            data: {
                'business_finance': {
                    '第一周：商业金融导论、企业目标与代理人博弈': [
                        { name: '第一周课程导学', file: 'courses/business_finance/第一周学习指南.html', type: 'free' },
                        { name: '模块一：财务经理的角色与企业投资决策', file: 'courses/business_finance/Week1_Module1.html', type: 'free' },
                        { name: '模块二：企业目标与代理理论', file: 'courses/business_finance/Week1_Module2.html', type: 'free' }
                    ]
                }
            },
            currentCourseId: 'business_finance'
        };

        // 版本号升级为 v5，强制浏览器加载上面的新路径！
        let state = JSON.parse(localStorage.getItem('cloud_edu_v5')) || DEFAULT_STATE;
        let currentUser = null; 
        let editingContext = null;

        function saveState() { localStorage.setItem('cloud_edu_v5', JSON.stringify(state)); }

        // --- 账号与权限系统 ---
        function showLogin() { document.getElementById('loginModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function doLogin() {
            const id = document.getElementById('loginId').value;
            const pwd = document.getElementById('loginPwd').value;
            const user = state.users.find(u => u.id === id && u.pwd === pwd);
            
            if(user) {
                currentUser = user;
                document.getElementById('currentUserLabel').innerText = `${user.id} (${user.role === 'admin' ? '管理员' : (user.pro ? 'Pro高级' : 'Free普通')})`;
                if(user.role === 'admin') document.body.classList.add('is-admin');
                else document.body.classList.remove('is-admin');
                closeModal('loginModal');
                renderAll();
            } else { alert("账号或密码错误"); }
        }

        // --- 用户管理后台 (Admin) ---
        function showUserManage() { renderUserTable(); document.getElementById('userManageModal').style.display = 'flex'; }
        function renderUserTable() {
            const tbody = state.users.map((u, i) => `
                <tr><td>${u.id}</td><td>${u.pwd}</td><td>${u.role}</td>
                <td><button onclick="toggleUserPro(${i})" class="btn ${u.pro ? 'btn-primary' : 'btn-ghost'}" style="padding:2px 5px; font-size:10px;">${u.pro ? 'Pro' : 'Free'}</button></td>
                <td><button onclick="deleteUser(${i})" class="btn btn-danger" style="padding:2px 5px; font-size:10px;">删</button></td></tr>
            `).join('');
            document.getElementById('userTable').innerHTML = `<tr><th>账号</th><th>密码</th><th>角色</th><th>权限</th><th>操作</th></tr>${tbody}`;
        }

        function addUser() {
            const id = document.getElementById('newUserId').value;
            const pwd = document.getElementById('newUserPwd').value;
            const role = document.getElementById('newUserRole').value;
            if(!id || !pwd) return alert("请填写完整");
            if(state.users.find(u=>u.id === id)) return alert("账号已存在");
            state.users.push({id, pwd, role, pro: role==='admin'});
            saveState(); renderUserTable();
        }
        function deleteUser(idx) { state.users.splice(idx,1); saveState(); renderUserTable(); }
        function toggleUserPro(idx) { state.users[idx].pro = !state.users[idx].pro; saveState(); renderUserTable(); renderAll();}

        // --- 界面渲染 ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function renderAll() {
            renderNav(); renderMindMap();
            if(currentUser?.role === 'admin') updateAdminSelects();
        }

        function renderNav() {
            const list = document.getElementById('courseList');
            if(!state.courses) state.courses = [];
            list.innerHTML = state.courses.map((c, index) => `
                <div class="course-item ${state.currentCourseId === c.id ? 'active' : ''}" onclick="switchCourse('${c.id}')">
                    <span><i class="fas ${state.currentCourseId === c.id ? 'fa-folder-open' : 'fa-folder'}"></i> ${c.name}</span>
                    <div class="sort-tool admin-only">
                        <button onclick="moveCourse(${index}, -1); event.stopPropagation();"><i class="fas fa-caret-up"></i></button>
                        <button onclick="moveCourse(${index}, 1); event.stopPropagation();"><i class="fas fa-caret-down"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderMindMap() {
            const canvas = document.getElementById('mainCanvas');
            const course = state.courses.find(c => c.id === state.currentCourseId);
            if (!course) { canvas.innerHTML = "<h3 style='color:#64748b;'>请让管理员添加课程</h3>"; return; }

            let html = `<div class="course-title-pill">${course.name}</div><div class="tree-container">`;
            const courseData = state.data[course.id] || {};
            
            Object.keys(courseData).forEach((week, wIdx) => {
                html += `
                    <div class="week-row">
                        <div>
                            <div class="week-box">
                                ${week}
                                <div class="admin-only" style="margin-top:8px; display:flex; justify-content:center; gap:8px;">
                                    <button class="btn btn-ghost" style="padding:2px 6px" onclick="moveWeek('${course.id}', ${wIdx}, -1)"><i class="fas fa-arrow-up"></i></button>
                                    <button class="btn btn-danger" style="padding:2px 6px" onclick="deleteWeek('${course.id}', '${week}')"><i class="fas fa-trash"></i></button>
                                    <button class="btn btn-ghost" style="padding:2px 6px" onclick="moveWeek('${course.id}', ${wIdx}, 1)"><i class="fas fa-arrow-down"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="modules-col">
                `;
                
                courseData[week].forEach((mod, mIdx) => {
                    let isLocked = false;
                    if(mod.type === 'pro') {
                        if(!currentUser) isLocked = true;
                        else if(!currentUser.pro) isLocked = true;
                    }

                    html += `
                        <div class="module-card ${isLocked ? 'locked' : ''}" onclick="${isLocked ? "alert('该课件仅高级权限可见，请联系校长升级账号。')" : `window.open('${mod.file}', '_blank')`}">
                            <div class="mod-title">
                                <i class="fas ${isLocked ? 'fa-lock' : 'fa-file-alt'}" style="color:${isLocked ? '#94a3b8' : 'var(--accent-green)'}"></i>
                                <span>${mod.name}</span>
                            </div>
                            <div class="sort-tool admin-only" onclick="event.stopPropagation()">
                                <button title="编辑" onclick="editMod('${course.id}', '${week}', ${mIdx})"><i class="fas fa-pen"></i></button>
                                <button title="上移" onclick="moveMod('${course.id}', '${week}', ${mIdx}, -1)"><i class="fas fa-caret-up"></i></button>
                                <button title="下移" onclick="moveMod('${course.id}', '${week}', ${mIdx}, 1)"><i class="fas fa-caret-down"></i></button>
                                <button title="删除" onclick="deleteMod('${course.id}', '${week}', ${mIdx})" style="color:#ef4444"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                });
                html += `</div></div>`;
            });
            canvas.innerHTML = html + `</div>`;
        }

        // --- 交互与管理逻辑 ---
        function switchCourse(id) { state.currentCourseId = id; renderAll(); if(window.innerWidth <= 768) toggleSidebar(); }
        function toggleAdminPanel() { document.getElementById('adminPanel').classList.toggle('open'); }
        function updateAdminSelects() { document.getElementById('parentCourseSelect').innerHTML = state.courses.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); }

        function addCourse() {
            const name = document.getElementById('courseNameInput').value;
            if (!name) return;
            const id = 'c_' + Date.now(); 
            state.courses.push({id, name});
            state.data[id] = {};
            saveState(); renderAll();
        }

        function deleteCurrentCourse() {
            if(!confirm("确定删除整个课程？")) return;
            state.courses = state.courses.filter(c => c.id !== state.currentCourseId);
            delete state.data[state.currentCourseId];
            state.currentCourseId = state.courses[0]?.id || null;
            saveState(); renderAll();
        }

        function editMod(cid, week, idx) {
            const mod = state.data[cid][week][idx];
            editingContext = { cid, week, idx };
            document.getElementById('parentCourseSelect').value = cid;
            document.getElementById('weekInput').value = week;
            document.getElementById('moduleNameInput').value = mod.name;
            document.getElementById('fileNameInput').value = mod.file;
            document.getElementById('accessSelect').value = mod.type;
            if(!document.getElementById('adminPanel').classList.contains('open')) toggleAdminPanel();
        }

        function saveModule() {
            const cid = document.getElementById('parentCourseSelect').value;
            const week = document.getElementById('weekInput').value;
            const mod = {
                name: document.getElementById('moduleNameInput').value,
                file: document.getElementById('fileNameInput').value,
                type: document.getElementById('accessSelect').value
            };
            if(!week || !mod.name || !mod.file) return alert("请填写完整");

            if(editingContext) state.data[editingContext.cid][editingContext.week].splice(editingContext.idx, 1);
            if(!state.data[cid][week]) state.data[cid][week] = [];
            state.data[cid][week].push(mod);
            editingContext = null;
            saveState(); renderAll(); alert("已保存");
        }

        // --- 排序与删除 ---
        function moveCourse(idx, dir) { const arr = state.courses; if(arr[idx+dir]) { [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]]; saveState(); renderAll(); } }
        function moveWeek(cid, idx, dir) {
            const keys = Object.keys(state.data[cid]);
            if(keys[idx+dir]) {
                const newObj = {};
                [keys[idx], keys[idx+dir]] = [keys[idx+dir], keys[idx]];
                keys.forEach(k => newObj[k] = state.data[cid][k]);
                state.data[cid] = newObj; saveState(); renderAll();
            }
        }
        function moveMod(cid, week, idx, dir) { const arr = state.data[cid][week]; if (arr[idx+dir]) { [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]]; saveState(); renderAll(); } }
        function deleteWeek(cid, week) { if(confirm("删除该周？")) { delete state.data[cid][week]; saveState(); renderAll(); } }
        function deleteMod(cid, week, idx) { state.data[cid][week].splice(idx, 1); saveState(); renderAll(); }

        // --- 备份导出 ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "cloud_edu_backup.json");
            document.body.appendChild(dl); dl.click(); dl.remove();
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    state = JSON.parse(e.target.result);
                    saveState(); location.reload(); 
                } catch (err) { alert("文件格式不正确"); }
            };
            reader.readAsText(file);
        }

        // 启动系统
        renderAll();
        setTimeout(showLogin, 500);

    </script>
</body>
</html>
